<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高熵合金/硬质合金计算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c7be5',
                        secondary: '#38a169',
                        neutral: '#f5f7fa',
                        dark: '#2d3748',
                        light: '#e2e8f0',
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'system-ui', 'sans-serif'],
                        mono: ['Consolas', 'monospace'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            .transition-height {
                transition: max-height 0.3s ease-in-out;
            }
        }
    </style>
    <style>
        /* 确保自动补全列表在输入框下方正确显示 */
        .ui-autocomplete {
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            background: white;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .ui-menu-item-wrapper {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .ui-state-active, .ui-state-focus {
            background: #e2e8f0; /* light gray */
            border-color: #e2e8f0;
            color: #2d3748; /* dark */
        }
    </style>
</head>
<body class="bg-neutral text-dark min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-primary mb-2">高熵合金/硬质合金计算器</h1>
            <p class="text-gray-600 max-w-3xl mx-auto">用于计算高熵合金和硬质合金的成分、质量比例和理论密度等参数的专业工具</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h2 class="text-xl font-bold text-primary mb-4 flex items-center">
                        <i class="fa fa-cogs mr-2"></i>计算模式
                    </h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">选择计算模式:</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="calcMode" value="heaa" checked 
                                    class="w-4 h-4 text-primary focus:ring-primary">
                                <span class="ml-2">高熵合金</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="calcMode" value="carbide" 
                                    class="w-4 h-4 text-primary focus:ring-primary">
                                <span class="ml-2">硬质合金</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="totalMass" id="totalMassLabel" class="block text-sm font-medium text-gray-700 mb-2">总质量 (g):</label>
                        <input type="number" id="totalMass" value="100" min="0.01" step="0.01"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                    </div>
                    
                    <div id="heaaModeOptions" class="mb-4">
                        <label for="inputMode" class="block text-sm font-medium text-gray-700 mb-2">输入模式:</label>
                        <select id="inputMode" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="atomicRatio">原子比</option>
                            <option value="massRatio">质量比</option>
                            <option value="massPercent">质量百分比</option>
                            <option value="massGrams">质量克</option>
                        </select>
                    </div>
                    
                    <div id="carbideModeOptions" class="hidden">
                        <h3 class="font-semibold text-gray-800 mb-3">硬质合金组成</h3>
                        
                        <div class="p-4 border border-gray-200 rounded-lg mb-4 bg-gray-50">
                            <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fa fa-diamond mr-2 text-red-600"></i>硬质相
                            </h4>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">硬质相类型:</label>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="hardphaseType" value="single" checked 
                                            class="w-4 h-4 text-primary focus:ring-primary">
                                        <span class="ml-2">单一化合物</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="hardphaseType" value="he" 
                                            class="w-4 h-4 text-primary focus:ring-primary">
                                        <span class="ml-2">高熵硬质相</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="singleHardphase" class="mb-4">
                                <div>
                                    <label for="matrixCompound" class="block text-sm font-medium text-gray-700 mb-2">硬质相化合物:</label>
                                    <select id="matrixCompound" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                        <option value="WC">WC</option>
                                        <option value="TiC">TiC</option>
                                        <option value="TaC">TaC</option>
                                        <option value="NbC">NbC</option>
                                        <option value="VC">VC</option>
                                        <option value="Cr3C2">Cr3C2</option>
                                        <option value="Mo2C">Mo2C</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="heHardphase" class="hidden mb-4">
                                <h4 class="font-medium text-gray-800 mb-3">高熵硬质相组成</h4>
                                
                                <div class="grid grid-cols-3 gap-4 mb-3 text-sm font-semibold">
                                    <div>金属元素</div>
                                    <div>原子比</div>
                                    <div>碳化物类型</div>
                                </div>
                                
                                <div id="hardphaseElements">
                                    </div>
                                
                                <div class="flex justify-center mt-4 space-x-3">
                                    <button id="addHardphaseElement" type="button" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                        <i class="fa fa-plus mr-1"></i> 添加元素
                                    </button>
                                    <button id="delHardphaseElement" type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                        <i class="fa fa-minus mr-1"></i> 删除元素
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 border border-gray-200 rounded-lg mb-4 bg-gray-50">
                            <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fa fa-tint mr-2 text-green-600"></i>粘结相
                            </h4>
                            
                            <div class="mb-4">
                                <label for="binderPercentInput" class="block text-sm font-medium text-gray-700 mb-2">粘结相质量百分比:</label>
                                <div class="flex">
                                    <input type="number" id="binderPercentInput" value="10" min="0" max="100" step="0.1"
                                        class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                    <span class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg">%</span>
                                </div>
                            </div>
                            
                            <div>
                                <label for="binderMode" class="block text-sm font-medium text-gray-700 mb-2">粘结相输入模式:</label>
                                <select id="binderMode" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="atomicRatio">原子比</option>
                                    <option value="massRatio">质量比</option>
                                    <option value="massPercent">质量百分比</option>
                                    <option value="massGrams">质量克</option>
                                </select>
                            </div>
                            </div>

                        <div class="p-4 border border-gray-200 rounded-lg mb-4 bg-gray-50">
                            <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fa fa-flask mr-2 text-blue-600"></i>添加剂（默认质量百分比添加）
                            </h4>
                            
                            <div class="grid grid-cols-3 gap-4 mb-3 text-sm font-semibold">
                                <div>来源类型</div>
                                <div>元素/化合物</div>
                                <div>质量百分比 (%)</div>
                            </div>
                            
                            <div id="additiveElements">
                                </div>
                            
                            <div class="flex justify-center mt-4 space-x-3">
                                <button id="addAdditiveElement" type="button" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                    <i class="fa fa-plus mr-1"></i> 添加添加剂
                                </button>
                                <button id="delAdditiveElement" type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                    <i class="fa fa-minus mr-1"></i> 删除添加剂
                                </button>
                            </div>
                        </div>

                        <div class="mt-4 grid grid-cols-3 gap-4">
                            <div class="bg-white p-3 rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-600">粘结相占比</p>
                                <p id="showBinderPercent" class="font-semibold text-primary">10.0%</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-600">添加剂占比</p>
                                <p id="showAdditivePercent" class="font-semibold text-primary">0.0%</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-600">硬质相占比</p>
                                <p id="showHardphasePercent" class="font-semibold text-primary">90.0%</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary flex items-center">
                            <i class="fa fa-flask mr-2"></i><span id="elementsTitle">元素组成</span>
                        </h2>
                        <div class="flex space-x-3">
                            <button id="addElement" type="button" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                <i class="fa fa-plus mr-1"></i> 添加元素
                            </button>
                            <button id="deleteElement" type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                <i class="fa fa-minus mr-1"></i> 删除元素
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4 mb-3 text-sm font-semibold">
                        <div>元素</div>
                        <div>比例</div>
                        <div>来源</div>
                        <div>碳化物类型</div>
                    </div>
                    
                    <div id="elementsContainer">
                        </div>
                </div>
                
                <div id="moldDimensions" class="bg-white rounded-xl p-6 card-shadow hidden">
                    <h2 class="text-xl font-bold text-primary mb-4 flex items-center">
                        <i class="fa fa-cube mr-2"></i>压制模具尺寸 (mm)
                    </h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="moldLength" class="block text-sm font-medium text-gray-700 mb-2">长度:</label>
                            <input type="number" id="moldLength" min="0.1" step="0.1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label for="moldWidth" class="block text-sm font-medium text-gray-700 mb-2">宽度:</label>
                            <input type="number" id="moldWidth" min="0.1" step="0.1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label for="moldHeight" class="block text-sm font-medium text-gray-700 mb-2">高度:</label>
                            <input type="number" id="moldHeight" min="0.1" step="0.1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label for="pressingLoss" class="block text-sm font-medium text-gray-700 mb-2">压制损失:</label>
                            <div class="flex">
                                <input type="number" id="pressingLoss" value="5" min="0" max="100" step="0.1"
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                <span class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg">%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="calculateBtn" type="button" class="px-8 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-lg font-medium">
                        <i class="fa fa-calculator mr-2"></i>计算
                    </button>
                </div>
            </div>
            
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl p-6 card-shadow h-full flex flex-col">
                    <h2 class="text-xl font-bold text-primary mb-4 flex items-center">
                        <i class="fa fa-bar-chart mr-2"></i>计算结果
                    </h2>
                    
                    <div class="flex-1 overflow-hidden flex flex-col">
                        <pre id="resultText" class="flex-1 overflow-auto p-4 bg-gray-50 rounded-lg text-sm font-mono leading-relaxed"></pre>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>高熵合金/硬质合金计算器 &copy; 2023</p>
        </footer>
    </div>

    <script>
        // 原子量数据（2019版IUPAC推荐值）
        const atomicWeights = {
            'H': 1.008, 'He': 4.0026, 'Li': 6.94, 'Be': 9.0122, 'B': 10.81, 'C': 12.011, 'N': 14.007, 'O': 15.999,
            'F': 18.998, 'Ne': 20.180, 'Na': 22.990, 'Mg': 24.305, 'Al': 26.982, 'Si': 28.085, 'P': 30.974,
            'S': 32.06, 'Cl': 35.45, 'Ar': 39.948, 'K': 39.098, 'Ca': 40.078, 'Sc': 44.956, 'Ti': 47.867,
            'V': 50.942, 'Cr': 51.996, 'Mn': 54.938, 'Fe': 55.845, 'Co': 58.933, 'Ni': 58.693, 'Cu': 63.546,
            'Zn': 65.38, 'Ga': 69.723, 'Ge': 72.630, 'As': 74.922, 'Se': 78.971, 'Br': 79.904, 'Kr': 83.798,
            'Rb': 85.468, 'Sr': 87.62, 'Y': 88.906, 'Zr': 91.224, 'Nb': 92.906, 'Mo': 95.95, 'Tc': 98,
            'Ru': 101.07, 'Rh': 102.91, 'Pd': 106.42, 'Ag': 107.87, 'Cd': 112.41, 'In': 114.82, 'Sn': 118.71,
            'Sb': 121.76, 'Te': 127.60, 'I': 126.90, 'Xe': 131.29, 'Cs': 132.91, 'Ba': 137.33, 'La': 138.91,
            'Ce': 140.12, 'Pr': 140.91, 'Nd': 144.24, 'Pm': 145, 'Sm': 150.36, 'Eu': 151.96, 'Gd': 157.25,
            'Tb': 158.93, 'Dy': 162.50, 'Ho': 164.93, 'Er': 167.26, 'Tm': 168.93, 'Yb': 173.05, 'Lu': 174.97,
            'Hf': 178.49, 'Ta': 180.95, 'W': 183.84, 'Re': 186.21, 'Os': 190.23, 'Ir': 192.22, 'Pt': 195.08,
            'Au': 196.97, 'Hg': 200.59, 'Tl': 204.38, 'Pb': 207.2, 'Bi': 208.98, 'Th': 232.04, 'Pa': 231.04,
            'U': 238.03
        };
        const allElements = Object.keys(atomicWeights); // 用于纯金属输入提示
        const metalElements = allElements.filter(e => e !== 'C' && e !== 'O' && e !== 'N' && e !== 'H'); 
        
        // 常见碳化物类型和其原子比例关系 [金属原子数, 碳原子数]
        const carbideTypes = {
            'MC': [1, 1],  // 如TiC, WC
            'M2C': [2, 1],  // 如Mo2C, W2C
            'M3C': [3, 1],  // 如Fe3C
            'M3C2': [3, 2],  // 如Cr3C2
            'M7C3': [7, 3],  // 如Cr7C3
            'M23C6': [23, 6]  // 如Cr23C6
        };

        // 常见碳化物/化合物列表 (用于选择)
        const compoundList = ['WC', 'TiC', 'TaC', 'NbC', 'VC', 'Cr3C2', 'Mo2C', 'W2C', 'Co3W3C', 'Ni3W3C'];
        
        // 常见材料的理论密度 (g/cm³)
        const materialDensities = {
            // 纯元素
            'W': 19.3, 'Ta': 16.4, 'Nb': 8.57, 'Ti': 4.51, 'Cr': 7.19, 'B': 2.34, 'Si': 2.33,
            'Mo': 10.22, 'V': 6.11, 'Fe': 7.87, 'Co': 8.9, 'Ni': 8.91,
            'Al': 2.7, 'Cu': 8.96, 'C': 2.26, 

            // 碳化物
            'WC': 15.7, 'TiC': 4.93, 'TaC': 14.5, 'NbC': 7.82, 'VC': 5.77,
            'Cr3C2': 6.68, 'Mo2C': 9.18, 'W2C': 17.2,

            // 其他化合物
            'Co3W3C': 14.0, 'Ni3W3C': 13.8,  // 典型的η相碳化物
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素引用
            const calcModeRadios = document.querySelectorAll('input[name="calcMode"]');
            const totalMassLabel = document.getElementById('totalMassLabel');
            const heaaModeOptions = document.getElementById('heaaModeOptions');
            const carbideModeOptions = document.getElementById('carbideModeOptions');
            const elementsTitle = document.getElementById('elementsTitle');
            const moldDimensions = document.getElementById('moldDimensions');
            const hardphaseTypeRadios = document.querySelectorAll('input[name="hardphaseType"]');
            const singleHardphase = document.getElementById('singleHardphase');
            const heHardphase = document.getElementById('heHardphase');
            const binderPercentInput = document.getElementById('binderPercentInput');
            const showBinderPercent = document.getElementById('showBinderPercent');
            const showAdditivePercent = document.getElementById('showAdditivePercent');
            const showHardphasePercent = document.getElementById('showHardphasePercent');
            const elementsContainer = document.getElementById('elementsContainer');
            const hardphaseElements = document.getElementById('hardphaseElements');
            const additiveElements = document.getElementById('additiveElements');
            const addElementBtn = document.getElementById('addElement');
            const deleteElementBtn = document.getElementById('deleteElement');
            const addHardphaseElementBtn = document.getElementById('addHardphaseElement');
            const delHardphaseElementBtn = document.getElementById('delHardphaseElement');
            const addAdditiveElementBtn = document.getElementById('addAdditiveElement');
            const delAdditiveElementBtn = document.getElementById('delAdditiveElement');
            const calculateBtn = document.getElementById('calculateBtn');
            const resultText = document.getElementById('resultText');

            // --- 核心功能函数定义 ---

            // 应用自动补全到指定的输入框
            function applyAutocomplete(inputElement) {
                $(inputElement).autocomplete({
                    source: function(request, response) {
                        const term = $.ui.autocomplete.escapeRegex(request.term).toUpperCase();
                        const matcher = new RegExp("^" + term, "i");
                        // 允许用户输入所有元素，包括C, O等，但主要引导金属元素
                        const filteredElements = allElements.filter(element => matcher.test(element));
                        response(filteredElements);
                    },
                    minLength: 1,
                    delay: 0
                });
            }

            // 初始化元素行（用于HEAA模式或硬质合金模式下的粘结相）
            function initElements(mode = 'heaa') {
                elementsContainer.innerHTML = '';
                // 默认初始化5行
                for(let i=0; i<5; i++) {
                    addElementRow('', 1, 'pure', 'MC', mode);
                }
            }

            // 初始化硬质相元素（用于高熵硬质相）
            function initHardphaseElements() {
                hardphaseElements.innerHTML = '';
                addHardphaseElementRow('W', 1);
                addHardphaseElementRow('Ta', 1);
                addHardphaseElementRow('Nb', 1);
                addHardphaseElementRow('Ti', 1);
            }

            // 初始化添加剂元素（默认Cr3C2和TaC）
            function initAdditiveElements() {
                additiveElements.innerHTML = '';
                addAdditiveElementRow('compound', 'Cr3C2', 0); // 默认Cr3C2化合物
                addAdditiveElementRow('compound', 'TaC', 0);   // 默认TaC化合物
                updatePhasePercentages(); // 初始化占比显示
            }
            
            // 添加元素行（通用，支持纯金属输入框或下拉选择）
            function addElementRow(element = '', ratio = 1, source = 'pure', carbideType = 'MC', mode = 'heaa') {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-4 gap-4 mb-2 element-row';
                row.dataset.index = elementsContainer.children.length;
                
                // 元素输入/选择 (文本输入并应用自动补全 - 无论哪种模式，只要是纯金属都用文本输入)
                let elementInput;
                
                const createElementInput = (currentSource) => {
                    let input;
                    if (currentSource === 'pure' || mode === 'heaa') { // HEAA模式下，所有元素都用文本输入
                        input = document.createElement('input');
                        input.type = 'text';
                        input.value = element;
                        input.placeholder = '如: Co, Fe, C...';
                        input.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary element-input pure-metal-input';
                        setTimeout(() => applyAutocomplete(input), 0); // 应用自动补全
                    } else {
                        // 硬质合金模式下，如果是碳化物来源，则强制使用选择框 (避免用户输错碳化物)
                        input = document.createElement('select');
                        input.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary element-select';
                        input.innerHTML = `<option value="">选择元素</option>`;
                        metalElements.forEach(elem => {
                            const option = document.createElement('option');
                            option.value = elem;
                            option.textContent = elem;
                            if (elem === element) option.selected = true;
                            input.appendChild(option);
                        });
                    }
                    return input;
                };

                elementInput = createElementInput(source);
                
                const ratioInput = document.createElement('input');
                ratioInput.type = 'number';
                ratioInput.value = ratio;
                ratioInput.min = 0.001;
                ratioInput.step = 0.001;
                ratioInput.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary ratio-input';
                
                const sourceSelect = document.createElement('select');
                sourceSelect.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary source-select';
                sourceSelect.innerHTML = `
                    <option value="pure">纯金属</option>
                    <option value="carbide">碳化物</option>
                `;
                sourceSelect.value = source;
                
                const carbideTypeSelect = document.createElement('select');
                carbideTypeSelect.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary carbide-type-select';
                Object.keys(carbideTypes).forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    if (type === carbideType) option.selected = true;
                    carbideTypeSelect.appendChild(option);
                });
                
                row.appendChild(elementInput);
                row.appendChild(ratioInput);
                row.appendChild(sourceSelect);
                row.appendChild(carbideTypeSelect);
                elementsContainer.appendChild(row);
                
                // 切换元素输入框/选择框
                sourceSelect.addEventListener('change', function() {
                    const newSource = this.value;
                    carbideTypeSelect.classList.toggle('hidden', newSource !== 'carbide');
                    
                    // 只有在硬质合金模式下，并且从纯金属切换到碳化物时，才切换元素选择框类型
                    if (mode === 'carbide') {
                        const oldElementInput = row.querySelector('.element-input, .element-select');
                        // 核心逻辑：粘结相中，纯金属是文本+补全，碳化物来源是下拉选择
                        const newElementInput = createElementInput(newSource); 
                        row.replaceChild(newElementInput, oldElementInput);
                    }
                });

                // 初始化状态显示
                carbideTypeSelect.classList.toggle('hidden', sourceSelect.value !== 'carbide');
            }

            // 添加硬质相元素行（HE Hardphase）
            function addHardphaseElementRow(element = '', ratio = 1) {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-3 gap-4 mb-2 hardphase-row';
                row.dataset.index = hardphaseElements.children.length;
                
                // 硬质相元素使用下拉选择，保证元素是金属
                const elementSelect = document.createElement('select');
                elementSelect.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary hp-element-select';
                elementSelect.innerHTML = `<option value="">选择金属</option>`;
                metalElements.forEach(elem => {
                    const option = document.createElement('option');
                    option.value = elem;
                    option.textContent = elem;
                    if (elem === element) option.selected = true;
                    elementSelect.appendChild(option);
                });
                
                const ratioInput = document.createElement('input');
                ratioInput.type = 'number';
                ratioInput.value = ratio;
                ratioInput.min = 0.001;
                ratioInput.step = 0.001;
                ratioInput.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary hp-ratio-input';
                
                const carbideTypeSelect = document.createElement('select');
                carbideTypeSelect.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary hp-carbide-type-select';
                Object.keys(carbideTypes).forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    if (type === 'MC') option.selected = true;
                    carbideTypeSelect.appendChild(option);
                });
                
                row.appendChild(elementSelect);
                row.appendChild(ratioInput);
                row.appendChild(carbideTypeSelect);
                hardphaseElements.appendChild(row);
            }

            // 添加添加剂元素行（支持化合物/纯金属，默认质量百分比）
            function addAdditiveElementRow(initSource = 'compound', initValue = 'Cr3C2', initPercent = 0) {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-3 gap-4 mb-2 additive-row';
                row.dataset.index = additiveElements.children.length;
                
                // 来源类型选择（纯金属/碳化物）
                const sourceTypeSelect = document.createElement('select');
                sourceTypeSelect.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary additive-source-select';
                sourceTypeSelect.innerHTML = `
                    <option value="pure">纯金属</option>
                    <option value="compound">碳化物</option>
                `;
                sourceTypeSelect.value = initSource;
                
                // 元素/化合物输入/选择 (纯金属文本输入 + 自动补全)
                const createContentInput = (currentSource, initialVal) => {
                    let input;
                    if (currentSource === 'pure') {
                        // 纯金属：文本输入 + 自动补全
                        input = document.createElement('input');
                        input.type = 'text';
                        input.value = initialVal; 
                        input.placeholder = '如: V, Nb...';
                        input.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary additive-content-input pure-metal-input';
                        setTimeout(() => applyAutocomplete(input), 0); // 应用自动补全
                    } else {
                        // 碳化物：下拉选择
                        input = document.createElement('select');
                        input.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary additive-content-select';
                        compoundList.forEach(comp => {
                            const option = document.createElement('option');
                            option.value = comp;
                            option.textContent = comp;
                            if (comp === initialVal) option.selected = true;
                            input.appendChild(option);
                        });
                    }
                    return input;
                };

                const contentInput = createContentInput(initSource, initValue);

                // 质量百分比输入
                const percentInput = document.createElement('input');
                percentInput.type = 'number';
                percentInput.value = initPercent;
                percentInput.min = 0;
                percentInput.max = 100;
                percentInput.step = 0.1;
                percentInput.className = 'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary additive-percent-input';
                
                // 组装行
                row.appendChild(sourceTypeSelect);
                row.appendChild(contentInput);
                row.appendChild(percentInput);
                additiveElements.appendChild(row);
                
                // 来源类型切换时更新内容选项
                sourceTypeSelect.addEventListener('change', function() {
                    const newSource = this.value;
                    const oldContentInput = row.querySelector('.additive-content-input, .additive-content-select');
                    
                    let initialVal = '';
                    if (newSource === 'pure') {
                        initialVal = '';
                    } else {
                        initialVal = 'WC';
                    }

                    const newContentInput = createContentInput(newSource, initialVal);
                    row.replaceChild(newContentInput, oldContentInput);

                    updatePhasePercentages(); // 切换类型可能影响添加剂总质量
                });
                
                // 百分比变化时更新相占比显示
                percentInput.addEventListener('input', updatePhasePercentages);
            }

            // 更新相占比显示
            function updatePhasePercentages() {
                const binderPercent = parseFloat(binderPercentInput.value) || 0;
                
                let additiveTotalPercent = 0;
                document.querySelectorAll('.additive-percent-input').forEach(input => {
                    additiveTotalPercent += parseFloat(input.value) || 0;
                });

                const totalOtherPercent = binderPercent + additiveTotalPercent;
                const hardphasePercent = Math.max(0, 100 - totalOtherPercent); // 硬质相占比为剩余部分

                // 检查总比例是否超过100% (仅在显示上进行警告，不自动修正输入值)
                const isOver100 = totalOtherPercent > 100.01;

                showBinderPercent.textContent = `${binderPercent.toFixed(1)}%`;
                showAdditivePercent.textContent = `${additiveTotalPercent.toFixed(1)}%`;
                showHardphasePercent.textContent = `${hardphasePercent.toFixed(1)}%`;
                
                [showBinderPercent, showAdditivePercent, showHardphasePercent].forEach(elem => {
                    elem.classList.toggle('text-red-600', isOver100);
                    elem.classList.toggle('text-primary', !isOver100);
                });
            }

            // 模式切换函数
            function switchMode(mode) {
                // 在切换模式时，销毁可能存在的旧元素的 autocomplete 实例
                document.querySelectorAll('.pure-metal-input').forEach(input => {
                    if ($(input).data('ui-autocomplete')) {
                        $(input).autocomplete('destroy');
                    }
                });

                if (mode === 'heaa') {
                    totalMassLabel.textContent = '总质量 (g):';
                    heaaModeOptions.classList.remove('hidden');
                    carbideModeOptions.classList.add('hidden');
                    elementsTitle.textContent = '元素组成 (高熵合金)';
                    moldDimensions.classList.add('hidden');
                    initElements('heaa'); // 重新初始化元素行（HEAA模式，元素输入都为文本+补全）
                    // 隐藏硬质相/碳化物选项
                    document.querySelectorAll('.source-select').forEach(select => select.value = 'pure');
                    document.querySelectorAll('.carbide-type-select').forEach(select => select.classList.add('hidden'));
                } else {
                    // carbide
                    totalMassLabel.textContent = '硬质合金总质量 (g):'; 
                    heaaModeOptions.classList.add('hidden');
                    carbideModeOptions.classList.remove('hidden');
                    elementsTitle.textContent = '粘结相元素组成';
                    moldDimensions.classList.remove('hidden');
                    initElements('carbide'); // 重新初始化元素行（硬质合金模式-粘结相）
                    initHardphaseElements(); // 初始化高熵硬质相元素
                    initAdditiveElements(); // 初始化添加剂元素
                    updatePhasePercentages(); // 初始化百分比显示
                }
            }

            // 解析化学式，返回 {元素: 原子数} 和分子量
            function parseCompound(formula) {
                const parts = formula.match(/([A-Z][a-z]*)(\d*)/g);
                const composition = {};
                let molecularWeight = 0;
                
                if (!parts) return { composition: {}, molecularWeight: 0 };

                for (let part of parts) {
                    const match = part.match(/([A-Z][a-z]*)(\d*)/);
                    if (!match) continue;
                    
                    const element = match[1];
                    const count = parseInt(match[2] || '1');
                    
                    if (atomicWeights[element]) {
                        composition[element] = (composition[element] || 0) + count;
                        molecularWeight += atomicWeights[element] * count;
                    }
                }
                return { composition, molecularWeight };
            }

            // 计算函数
            function calculate() {
                const currentMode = document.querySelector('input[name="calcMode"]:checked').value;
                const totalMass = parseFloat(document.getElementById('totalMass').value);
                
                if (isNaN(totalMass) || totalMass <= 0) {
                    resultText.textContent = '错误: 总质量必须大于0。';
                    return;
                }

                let results = `计算结果:\n\n`;
                let totalC_g = 0;
                let totalMass_g = 0;
                let totalVolume_cm3 = 0;
                
                if (currentMode === 'heaa') {
                    // --- 高熵合金模式计算 ---
                    const inputMode = document.getElementById('inputMode').value;
                    const elementRows = Array.from(elementsContainer.querySelectorAll('.element-row'));
                    
                    let elementsData = [];
                    elementRows.forEach(row => {
                        // HEAA模式下，元素输入框为文本输入框（.element-input）
                        const element = row.querySelector('.element-input').value.trim(); 
                        const ratio = parseFloat(row.querySelector('.ratio-input').value) || 0;
                        const source = row.querySelector('.source-select').value;
                        const carbideType = row.querySelector('.carbide-type-select').value;
                        
                        if (element && ratio > 0) {
                            elementsData.push({ element, ratio, source, carbideType });
                        }
                    });

                    if (elementsData.length === 0) {
                        resultText.textContent = '错误: 请输入至少一个元素及其比例。';
                        return;
                    }

                    // 1. 标准化比例/计算总摩尔数/总质量
                    let normalizedData = [];
                    let totalMoles = 0;      
                    let totalMass_input = 0; 

                    elementsData.forEach(item => {
                        if (!atomicWeights[item.element]) {
                            results += `警告: 元素 ${item.element} 的原子量未知，已跳过。\n`;
                            return;
                        }
                        
                        let molarMass = atomicWeights[item.element];
                        let massGrams = 0;
                        let moles = 0;

                        if (inputMode === 'atomicRatio') {
                            moles = item.ratio;
                            massGrams = moles * molarMass;
                        } else if (inputMode === 'massRatio') {
                            massGrams = item.ratio;
                            moles = massGrams / molarMass;
                        } else if (inputMode === 'massPercent') {
                            massGrams = totalMass * (item.ratio / 100);
                            moles = massGrams / molarMass;
                        } else if (inputMode === 'massGrams') {
                            massGrams = item.ratio;
                            moles = massGrams / molarMass;
                            totalMass_input += massGrams;
                        }
                        
                        normalizedData.push({ ...item, molarMass, moles, massGrams });
                        totalMoles += moles;
                    });
                    
                    // 最终质量百分比和克数
                    if (inputMode === 'massGrams') {
                        totalMass_g = totalMass_input;
                    } else if (inputMode === 'massPercent') {
                        totalMass_g = totalMass;
                    } else {
                        // 原子比/质量比输入，按比例缩放至设定的总质量
                        totalMass_g = totalMass;
                        let currentTotalMass = normalizedData.reduce((sum, item) => sum + item.massGrams, 0);
                        let scaleFactor = currentTotalMass > 0 ? totalMass / currentTotalMass : 0;
                        
                        normalizedData = normalizedData.map(item => ({
                            ...item,
                            massGrams: item.massGrams * scaleFactor,
                            moles: item.moles * scaleFactor
                        }));
                    }
                    
                    // 2. 详细计算和结果整理
                    results += `高熵合金计算结果:\n\n`;
                    
                    totalC_g = 0;

                    normalizedData.forEach((item, index) => {
                        const finalMass = item.massGrams;
                        const massPercent = (finalMass / totalMass_g) * 100;
                        const density = materialDensities[item.element] || 7.0; 
                        const volume = density > 0 ? finalMass / density : 0;
                        
                        totalVolume_cm3 += volume;
                        
                        let carbonMassInItem = 0;
                        if (item.element === 'C') {
                            carbonMassInItem = finalMass;
                        }
                        
                        totalC_g += carbonMassInItem;

                        results += `${index + 1}. ${item.element} (${massPercent.toFixed(2)} wt%):\n`;
                        results += `  ${item.element}: ${finalMass.toFixed(4)} g (${massPercent.toFixed(2)} wt%)\n`;
                        results += `  体积: ${volume.toFixed(4)} cm³\n`;
                    });

                    // 3. 结果汇总
                    const averageMolarMass = totalMass_g / totalMoles;
                    const theoreticalDensity = totalMass_g / totalVolume_cm3;
                    
                    results += `\n4. 总碳量: ${totalC_g.toFixed(4)} g (${(totalC_g / totalMass_g * 100).toFixed(2)} wt%)\n`;
                    results += `\n5. 理论密度计算:\n`;
                    results += `  总质量: ${totalMass_g.toFixed(4)} g\n`;
                    results += `  总体积: ${totalVolume_cm3.toFixed(4)} cm³\n`;
                    results += `  理论密度: ${theoreticalDensity.toFixed(2)} g/cm³\n`;
                    results += `  平均原子量: ${averageMolarMass.toFixed(2)} g/mol\n`;
                    results += `\n6. 质量总计: ${totalMass_g.toFixed(4)} g (目标总质量: ${totalMass.toFixed(4)} g)\n`;


                } 
                // --- 硬质合金模式计算 ---
                else {
                    const binderPercent = parseFloat(binderPercentInput.value) || 0;
                    
                    let additiveTotalPercent = 0;
                    const additiveRows = Array.from(additiveElements.querySelectorAll('.additive-row'));
                    const additiveData = [];
                    additiveRows.forEach(row => {
                        const source = row.querySelector('.additive-source-select').value;
                        const contentInput = row.querySelector('.additive-content-input, .additive-content-select');
                        const content = contentInput.value.trim();
                        const percent = parseFloat(row.querySelector('.additive-percent-input').value) || 0;
                        if (content && percent > 0) {
                            additiveData.push({ source, content, percent });
                            additiveTotalPercent += percent;
                        }
                    });

                    const totalOtherPercent = binderPercent + additiveTotalPercent;
                    
                    if (totalOtherPercent > 100.01) { 
                        resultText.textContent = `错误: 粘结相(${binderPercent.toFixed(1)}%)和添加剂(${additiveTotalPercent.toFixed(1)}%)总质量百分比已超过100%! 请检查输入。`;
                        return;
                    }

                    const hardphasePercent = 100 - totalOtherPercent;
                    
                    // 各相的实际质量
                    const hardphaseMass = totalMass * (hardphasePercent / 100);
                    const binderMass = totalMass * (binderPercent / 100);
                    const additiveMass = totalMass * (additiveTotalPercent / 100);

                    totalMass_g = totalMass; 
                    
                    let hardphaseDetails = {};
                    let hardphaseTotalC_g = 0;
                    let hardphaseTotalVolume_cm3 = 0;
                    let hardphaseDensity = 0;

                    // 1. 硬质相计算 (略，保持不变)
                    const hardphaseType = document.querySelector('input[name="hardphaseType"]:checked').value;
                    let hardphaseName = '';

                    if (hardphaseMass > 0) {
                        if (hardphaseType === 'single') {
                            const compound = document.getElementById('matrixCompound').value;
                            hardphaseName = compound;
                            const { composition, molecularWeight } = parseCompound(compound);
                            hardphaseDensity = materialDensities[compound] || 14.0;
                            
                            if (molecularWeight > 0) {
                                for (const element in composition) {
                                    const elementCount = composition[element];
                                    const elementMass = hardphaseMass * (atomicWeights[element] * elementCount / molecularWeight);
                                    hardphaseDetails[element] = { mass: elementMass, wtPercent: (elementMass / totalMass) * 100 };
                                    if (element === 'C') hardphaseTotalC_g += elementMass;
                                }
                            }
                            hardphaseTotalVolume_cm3 = hardphaseMass / hardphaseDensity;
                        } else {
                            // 高熵硬质相 (HE Hardphase) 略，保持不变
                            const heHardphaseRows = Array.from(hardphaseElements.querySelectorAll('.hardphase-row'));
                            let heHardphaseElementsData = [];
                            heHardphaseRows.forEach(row => {
                                const element = row.querySelector('.hp-element-select').value.trim();
                                const ratio = parseFloat(row.querySelector('.hp-ratio-input').value) || 0;
                                const carbideType = row.querySelector('.hp-carbide-type-select').value;
                                if (element && ratio > 0) {
                                    heHardphaseElementsData.push({ element, ratio, carbideType });
                                }
                            });

                            let totalMetalMass_ratio = 0;
                            let totalC_moles_carbide = 0;

                            heHardphaseElementsData.forEach(item => {
                                const [metalRatio, carbonRatio] = carbideTypes[item.carbideType];
                                const moles = item.ratio; 
                                const molarMass = atomicWeights[item.element] || 0;
                                
                                totalMetalMass_ratio += moles * molarMass;
                                totalC_moles_carbide += moles * (carbonRatio / metalRatio);
                                
                                hardphaseName += item.element + (item.ratio > 1 ? item.ratio.toFixed(0) : '') + item.carbideType.substring(0, 1) + 'x';
                            });

                            const totalHardphaseMass_ratio = totalMetalMass_ratio + totalC_moles_carbide * atomicWeights['C'];
                            const scaleFactor = totalHardphaseMass_ratio > 0 ? hardphaseMass / totalHardphaseMass_ratio : 0;

                            let totalCarbonMassInHE = totalC_moles_carbide * atomicWeights['C'] * scaleFactor;
                            
                            heHardphaseElementsData.forEach(item => {
                                const itemMass = item.ratio * atomicWeights[item.element] * scaleFactor;
                                const density = materialDensities[item.element] || 10.0;
                                hardphaseDetails[item.element] = { mass: itemMass, wtPercent: (itemMass / totalMass) * 100, volume: itemMass / density };
                                hardphaseTotalVolume_cm3 += itemMass / density;
                            });
                            
                            hardphaseDetails['C'] = { mass: totalCarbonMassInHE, wtPercent: (totalCarbonMassInHE / totalMass) * 100, volume: totalCarbonMassInHE / (materialDensities['C'] || 2.26) };
                            hardphaseTotalC_g = totalCarbonMassInHE;
                            hardphaseTotalVolume_cm3 += hardphaseDetails['C'].volume;

                            hardphaseDensity = hardphaseTotalVolume_cm3 > 0 ? hardphaseMass / hardphaseTotalVolume_cm3 : 14.0;
                        }
                    }

                    // 2. 粘结相计算 (HEA) (略，保持不变)
                    const binderElementRows = Array.from(elementsContainer.querySelectorAll('.element-row'));
                    const binderInputMode = document.getElementById('binderMode').value;
                    let binderDetails = {};
                    let binderTotalC_g = 0;
                    let binderTotalVolume_cm3 = 0;
                    let binderDensity = 8.54; 

                    if (binderMass > 0) {
                        const binderCalcResult = calculateHEA(binderElementRows, binderInputMode, binderMass, totalMass);
                        binderDetails = binderCalcResult.details;
                        binderTotalC_g = binderCalcResult.totalC_g;
                        binderTotalVolume_cm3 = binderCalcResult.totalVolume_cm3;
                        binderDensity = binderCalcResult.theoreticalDensity;
                    }

                    // 3. 添加剂计算
                    let additiveDetails = {};
                    let additiveTotalC_g = 0;
                    let additiveTotalVolume_cm3 = 0;
                    let additiveMassSum = 0;
                    
                    additiveData.forEach(item => {
                        const itemMass = totalMass * (item.percent / 100);
                        additiveMassSum += itemMass;
                        
                        let density = 8.0; 
                        let volume = 0;
                        let C_mass = 0;
                        
                        if (item.source === 'pure') {
                            // 纯金属
                            density = materialDensities[item.content] || 8.0;
                            volume = density > 0 ? itemMass / density : 0;
                            additiveDetails[item.content] = { mass: itemMass, wtPercent: (itemMass / totalMass) * 100, isPure: true, density: density };
                        } else {
                            // 碳化物
                            density = materialDensities[item.content] || 8.0;
                            volume = density > 0 ? itemMass / density : 0;
                            
                            const { composition, molecularWeight } = parseCompound(item.content);
                            if (molecularWeight > 0) {
                                for (const element in composition) {
                                    const elementCount = composition[element];
                                    const elementMass = itemMass * (atomicWeights[element] * elementCount / molecularWeight);
                                    
                                    if (element === 'C') {
                                        C_mass += elementMass;
                                    }
                                    
                                    additiveDetails[`${item.content}-${element}`] = { 
                                        mass: elementMass, 
                                        wtPercent: (elementMass / totalMass) * 100, 
                                        compound: item.content,
                                        density: density // 使用化合物的密度
                                    };
                                }
                            }
                        }
                        
                        additiveTotalC_g += C_mass;
                        additiveTotalVolume_cm3 += volume; 
                    });
                    
                    // 计算添加剂的加权平均密度
                    const additiveAverageDensity = additiveTotalVolume_cm3 > 0 ? additiveMassSum / additiveTotalVolume_cm3 : 0;

                    // 汇总总碳量和总体积
                    totalC_g = hardphaseTotalC_g + binderTotalC_g + additiveTotalC_g;
                    totalVolume_cm3 = hardphaseTotalVolume_cm3 + binderTotalVolume_cm3 + additiveTotalVolume_cm3;
                    const theoreticalDensity = totalVolume_cm3 > 0 ? totalMass_g / totalVolume_cm3 : 0; 

                    // 4. 结果格式化
                    
                    // 硬质相结果 (略，保持不变)
                    results += `硬质合金计算结果:\n\n`;
                    results += `1. 硬质相(${hardphaseName}, ${hardphasePercent.toFixed(1)}%):\n`;
                    for (const element in hardphaseDetails) {
                        const detail = hardphaseDetails[element];
                        results += `  ${element}: ${detail.mass.toFixed(4)} g (${detail.wtPercent.toFixed(2)} wt%)\n`;
                    }
                    results += `  硬质相总计: ${hardphaseMass.toFixed(4)} g\n`;
                    results += `\n`;

                    // 粘结相结果 (略，保持不变)
                    results += `2. 粘结相(HEA, ${binderPercent.toFixed(1)}%):\n`;
                    if (binderMass > 0) {
                        for (const element in binderDetails) {
                            const detail = binderDetails[element];
                            results += `  ${element}(${detail.source === 'pure' ? '纯金属' : detail.carbideType}): ${detail.mass.toFixed(4)} g (${detail.wtPercent.toFixed(2)} wt%)\n`;
                        }
                        results += `  粘结相总计: ${binderMass.toFixed(4)} g\n`;
                    } else {
                         results += `  未添加粘结相\n`;
                         results += `  粘结相总计: ${binderMass.toFixed(4)} g\n`;
                    }
                    results += `\n`;
                    
                    // 添加剂结果 (略，保持不变)
                    results += `3. 添加剂(${additiveTotalPercent.toFixed(1)}%):\n`;
                    if (additiveMass > 0) {
                        let currentCompound = '';
                        const sortedKeys = Object.keys(additiveDetails).sort((a, b) => {
                            const detailA = additiveDetails[a];
                            const detailB = additiveDetails[b];
                            if (detailA.isPure && !detailB.isPure) return -1;
                            if (!detailA.isPure && detailB.isPure) return 1;
                            return a.localeCompare(b);
                        });
                        
                        sortedKeys.forEach(key => {
                            const detail = additiveDetails[key];
                            const isCompound = key.includes('-');
                            
                            if (detail.isPure) {
                                results += `  ${key}(纯金属): ${detail.mass.toFixed(4)} g (${detail.wtPercent.toFixed(2)} wt%)\n`;
                            } else if (isCompound) {
                                const [compoundName, element] = key.split('-');
                                if (compoundName !== currentCompound) {
                                    results += `  化合物 ${compoundName}:\n`;
                                    currentCompound = compoundName;
                                }
                                results += `    ${element}: ${detail.mass.toFixed(4)} g (${detail.wtPercent.toFixed(2)} wt%)\n`;
                            }
                        });

                        results += `  添加剂总计: ${additiveMass.toFixed(4)} g\n`;
                    } else {
                        results += `  未添加任何添加剂\n`;
                        results += `  添加剂总计: ${additiveMass.toFixed(4)} g\n`;
                    }
                    results += `\n`;

                    // 总碳量 (略，保持不变)
                    results += `4. 总碳量:\n`;
                    results += `  硬质相 C含量: ${hardphaseTotalC_g.toFixed(4)} g (${(hardphaseTotalC_g / totalMass * 100).toFixed(2)} wt%)\n`;
                    results += `  粘结相 C含量: ${binderTotalC_g.toFixed(4)} g (${(binderTotalC_g / totalMass * 100).toFixed(2)} wt%)\n`;
                    results += `  添加剂 C含量: ${additiveTotalC_g.toFixed(4)} g (${(additiveTotalC_g / totalMass * 100).toFixed(2)} wt%)\n`;
                    results += `  总计: ${totalC_g.toFixed(4)} g (${(totalC_g / totalMass * 100).toFixed(2)} wt%)\n`;
                    results += `\n`;

                    // 5. 理论密度 (核心修改: 增加添加剂密度)
                    results += `5. 理论密度计算:\n`;
                    results += `  硬质相(${hardphaseName || 'N/A'})密度: ${hardphaseMass > 0 ? hardphaseDensity.toFixed(2) : 0.00} g/cm³\n`;
                    results += `  粘结相密度: ${binderMass > 0 ? binderDensity.toFixed(2) : 0.00} g/cm³ (估算值)\n`;
                    results += `  添加剂平均密度: ${additiveMass > 0 ? additiveAverageDensity.toFixed(2) : 0.00} g/cm³\n`; // 新增行
                    results += `  整体理论密度: ${theoreticalDensity.toFixed(2)} g/cm³\n`;
                    results += `\n`;
                    
                    // 模具尺寸 (略，保持不变)
                    const moldLength = parseFloat(document.getElementById('moldLength').value) || 0;
                    const moldWidth = parseFloat(document.getElementById('moldWidth').value) || 0;
                    const moldHeight = parseFloat(document.getElementById('moldHeight').value) || 0;
                    const pressingLoss = parseFloat(document.getElementById('pressingLoss').value) || 0;
                    
                    if (moldLength > 0 && moldWidth > 0 && moldHeight > 0 && theoreticalDensity > 0) {
                        const moldVolume = moldLength * moldWidth * moldHeight / 1000; // 转换为cm3
                        const theoreticalMass = theoreticalDensity * moldVolume;
                        const actualRequiredMass = theoreticalMass * (1 + pressingLoss / 100);
                        
                        let moldResults = `6. 模具尺寸计算:\n`;
                        moldResults += `  模具体积: ${moldVolume.toFixed(2)} cm³\n`;
                        moldResults += `  理论需粉质量: ${theoreticalMass.toFixed(4)} g\n`;
                        moldResults += `  考虑压制损失(${pressingLoss.toFixed(1)}%)后需粉质量: ${actualRequiredMass.toFixed(4)} g\n`;
                        results += moldResults;
                    }

                    // 质量总计 (略，保持不变)
                    results += `\n7. 质量总计: ${totalMass_g.toFixed(4)} g (目标总质量: ${totalMass.toFixed(4)} g)\n`;
                }

                resultText.textContent = results;
            }

            // 粘结相/HEAA的计算逻辑封装 (用于硬质合金中的粘结相) (略，保持不变)
            function calculateHEA(elementRows, inputMode, targetMass, totalAlloyMass) {
                let elementsData = [];
                elementRows.forEach(row => {
                    const elementInput = row.querySelector('.element-input, .element-select');
                    const element = elementInput.value.trim();
                    const ratio = parseFloat(row.querySelector('.ratio-input').value) || 0;
                    const source = row.querySelector('.source-select').value;
                    const carbideType = row.querySelector('.carbide-type-select').value;
                    
                    if (element && ratio > 0) {
                        elementsData.push({ element, ratio, source, carbideType });
                    }
                });
                
                let normalizedData = [];
                let currentTotalMass = 0;

                elementsData.forEach(item => {
                    if (!atomicWeights[item.element]) return;
                    
                    const molarMass = atomicWeights[item.element];
                    let massGrams = 0;
                    let moles = 0;

                    if (inputMode === 'atomicRatio') {
                        moles = item.ratio;
                        massGrams = moles * molarMass;
                    } else if (inputMode === 'massRatio') {
                        massGrams = item.ratio;
                        moles = massGrams / molarMass;
                    } else if (inputMode === 'massPercent') {
                        massGrams = targetMass * (item.ratio / 100);
                        moles = massGrams / molarMass;
                    } else if (inputMode === 'massGrams') {
                        massGrams = item.ratio;
                        moles = massGrams / molarMass;
                    }
                    
                    currentTotalMass += massGrams;
                    normalizedData.push({ ...item, molarMass, moles, massGrams });
                });

                if (inputMode === 'atomicRatio' || inputMode === 'massRatio') {
                    const scaleFactor = currentTotalMass > 0 ? targetMass / currentTotalMass : 0;
                    normalizedData = normalizedData.map(item => ({
                        ...item,
                        massGrams: item.massGrams * scaleFactor,
                        moles: item.moles * scaleFactor
                    }));
                    currentTotalMass = targetMass;
                } 

                let binderDetails = {};
                let totalC_g = 0;
                let totalVolume_cm3 = 0;
                
                normalizedData.forEach(item => {
                    const finalMass = item.massGrams;
                    const density = materialDensities[item.element] || 7.0; 
                    const volume = density > 0 ? finalMass / density : 0;
                    
                    totalVolume_cm3 += volume;
                    
                    let carbonMassInItem = 0;
                    if (item.element === 'C') {
                        carbonMassInItem = finalMass;
                    } else if (item.source === 'carbide') {
                        const [metalRatio, carbonRatio] = carbideTypes[item.carbideType];
                        const carbonMolarMass = atomicWeights['C'];
                        const metalMolarMass = atomicWeights[item.element];
                        const compoundMolarMass = metalRatio * metalMolarMass + carbonRatio * carbonMolarMass;
                        
                        const carbonMassFraction = compoundMolarMass > 0 ? (carbonRatio * carbonMolarMass) / compoundMolarMass : 0;
                        carbonMassInItem = finalMass * carbonMassFraction;
                    }
                    totalC_g += carbonMassInItem;

                    binderDetails[item.element] = { 
                        mass: finalMass, 
                        wtPercent: (finalMass / totalAlloyMass) * 100, 
                        source: item.source,
                        carbideType: item.carbideType
                    };
                });
                
                const theoreticalDensity = currentTotalMass / totalVolume_cm3;

                return {
                    details: binderDetails,
                    totalC_g: totalC_g,
                    totalVolume_cm3: totalVolume_cm3,
                    theoreticalDensity: theoreticalDensity || 8.54 
                };
            }

            // --- 事件监听器 ---

            // 模式切换
            calcModeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    switchMode(this.value);
                });
            });

            // 初始化（默认HEAA模式）
            switchMode('heaa');

            // 硬质相类型切换 (单一化合物 vs 高熵硬质相) (略，保持不变)
            hardphaseTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    singleHardphase.classList.toggle('hidden', this.value !== 'single');
                    heHardphase.classList.toggle('hidden', this.value !== 'he');
                });
            });

            // 粘结相百分比输入 (略，保持不变)
            binderPercentInput.addEventListener('input', updatePhasePercentages);
            
            // 元素行操作（粘结相/HEAA）
            addElementBtn.addEventListener('click', () => {
                const currentMode = document.querySelector('input[name="calcMode"]:checked').value;
                addElementRow('', 1, 'pure', 'MC', currentMode);
            });
            deleteElementBtn.addEventListener('click', () => {
                if (elementsContainer.lastElementChild) {
                    // 在删除前，先销毁可能存在的 autocomplete 实例
                    const lastRow = elementsContainer.lastElementChild;
                    const inputElement = lastRow.querySelector('.pure-metal-input');
                    if (inputElement && $(inputElement).data('ui-autocomplete')) {
                        $(inputElement).autocomplete('destroy');
                    }
                    elementsContainer.removeChild(lastRow);
                }
            });

            // 硬质相元素操作（HE Hardphase） (略，保持不变)
            addHardphaseElementBtn.addEventListener('click', () => addHardphaseElementRow('W', 1));
            delHardphaseElementBtn.addEventListener('click', () => {
                if (hardphaseElements.lastElementChild) {
                    hardphaseElements.removeChild(hardphaseElements.lastElementChild);
                }
            });

            // 添加剂元素操作 (略，保持不变)
            addAdditiveElementBtn.addEventListener('click', () => addAdditiveElementRow('compound', 'WC', 0)); 
            delAdditiveElementBtn.addEventListener('click', () => {
                if (additiveElements.lastElementChild) {
                    // 销毁可能存在的 autocomplete 实例
                    const lastRow = additiveElements.lastElementChild;
                    const inputElement = lastRow.querySelector('.pure-metal-input');
                    if (inputElement && $(inputElement).data('ui-autocomplete')) {
                        $(inputElement).autocomplete('destroy');
                    }
                    additiveElements.removeChild(lastRow);
                    updatePhasePercentages(); 
                }
            });

            // 计算按钮
            calculateBtn.addEventListener('click', calculate);
        });
    </script>
</body>
</html>
